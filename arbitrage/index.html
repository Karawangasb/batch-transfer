<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTMX Liquidity Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>RTMX Liquidity Dashboard</h1>
        <p class="lead">
          <a href="https://polygonscan.com/token/0xcd3bec5b18c05c48e7b18d31981947f3bed2624d" 
             target="_blank" rel="noopener noreferrer" class="link">
            Route Matrix (RTMX)
          </a>
          — Live snapshot likuiditas RTMX per pair. Cocok untuk monitoring & route discovery.
        </p>
      </div>

      <div class="status">
        <span id="lastFetch" class="muted">—</span>
        <div class="dot" id="fetchDot" style="background:#f97316"></div>
      </div>
    </header>

    <section class="card">
      <div class="controls">
        <input id="search" class="input small" placeholder="Cari pair / token / dex..." />
        <select id="sortBy" class="input small">
          <option value="none">Sort: Default</option>
          <option value="rtmx_desc">RTMX Reserve ↓</option>
          <option value="rtmx_asc">RTMX Reserve ↑</option>
          <option value="token_desc">Token Reserve ↓</option>
          <option value="token_asc">Token Reserve ↑</option>
        </select>

        <label style="display:flex;align-items:center;gap:6px">
          <input id="autoRefresh" type="checkbox" checked /> <span class="muted" style="font-size:13px">Auto refresh</span>
        </label>

        <input id="interval" class="input small" type="number" min="10" value="60" style="width:88px" title="Interval detik" />
        <button id="refreshBtn" class="btn">Refresh now</button>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="downloadCsv" class="btn ghost">Download CSV</button>
          <button id="openSheet" class="btn ghost">Open Sheet</button>
        </div>
      </div>

      <!-- Summary Totals -->
      <div class="summary">
        <div class="summary-item">
          <span class="summary-label">Total RTMX Reserved</span>
          <span id="totalRtmx">—</span> RTMX
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Liquidity (USD)</span>
          <span id="totalLiquidity">—</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Reserved (%)</span>
          <span id="pctReserved">—</span>%
        </div>
        <div class="summary-item">
          <span class="summary-label">Sisa (%)</span>
          <span id="pctRemaining">—</span>%
        </div>
      </div>

      <div style="overflow:auto">
        <table id="dataTable" aria-live="polite">
          <thead>
            <tr>
              <th style="width:120px">DEX</th>
              <th>Pair</th>
              <th style="width:150px">RTMX Reserve</th>
              <th style="width:150px">Token Reserve</th>
              <th style="width:220px">Pair Address</th>
              <th style="width:160px">Updated</th>
              <th style="width:160px">Total Liquidity</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="empty">Memuat data…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager" id="pagerWrap" style="display:none">
        <div id="pagerButtons"></div>
      </div>
    </section>

    <footer style="margin-top:14px;color:var(--muted);font-size:13px">
      Template by Ahmad Sobandi — gunakan bersama Google Apps Script yang mem-push data ke sheet.
    </footer>
  </div>

  <script>
    const SPREADSHEET_ID = '1IT7sHQQqSjyWnJLPMNi9fQQSb9-pRB7R5sr03-E0nug';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;
    const PAGE_SIZE = 25;
    const TOTAL_SUPPLY = 1_000_000_000_000; // 1 trillion RTMX

    // UI refs
    const tbody = document.getElementById('tbody');
    const lastFetchEl = document.getElementById('lastFetch');
    const fetchDot = document.getElementById('fetchDot');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefresh = document.getElementById('autoRefresh');
    const intervalInput = document.getElementById('interval');
    const searchInput = document.getElementById('search');
    const sortSelect = document.getElementById('sortBy');
    const pagerWrap = document.getElementById('pagerWrap');
    const pagerButtons = document.getElementById('pagerButtons');
    const downloadCsv = document.getElementById('downloadCsv');
    const openSheet = document.getElementById('openSheet');
    const totalRtmxEl = document.getElementById('totalRtmx');
    const totalLiquidityEl = document.getElementById('totalLiquidity');
    const pctReservedEl = document.getElementById('pctReserved');
    const pctRemainingEl = document.getElementById('pctRemaining');

    let rawRows = [];
    let filtered = [];
    let currentPage = 1;
    let refreshTimer = null;

    function setStatusLoading(loading){
      if(loading){
        lastFetchEl.textContent = 'Memuat...';
        fetchDot.style.background = '#f97316';
      } else {
        fetchDot.style.background = '#10b981';
      }
    }

    function formatNumber(val){
      if(val === null || val === '' || isNaN(Number(val))) return '-';
      const n = Number(val);
      if(n >= 1) return n.toLocaleString(undefined, {maximumFractionDigits: 6});
      return n.toPrecision(6);
    }

    function toPolygonscanLink(addr){
      if(!addr) return '';
      return `https://polygonscan.com/address/${addr}`;
    }

    function parseGoogleDateCell(cellValue) {
      const str = (cellValue || '').toString().trim();
      const match = str.match(/Date$$(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)$$/);
      if (!match) return null;
      const [, y, M, d, h, m, s] = match.map(Number);
      return new Date(y, M, d, h, m, s);
    }

    function formatUpdatedCell(cellValue) {
      const date = parseGoogleDateCell(cellValue);
      if (!date || isNaN(date)) return '-';
      return date.toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });
    }

    function parseGviz(text){
      // More robust: handle leading/trailing whitespace and optional comments
      let jsonText = text.trim();
      if (jsonText.startsWith("/*")) {
        const end = jsonText.indexOf("*/") + 2;
        jsonText = jsonText.substring(end).trim();
      }
      if (jsonText.startsWith("google.visualization.Query.setResponse(")) {
        jsonText = jsonText.replace(/^google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
      } else {
        // Fallback: try to extract JSON between parentheses
        const match = jsonText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/);
        if (match) jsonText = match[1];
      }
      return JSON.parse(jsonText);
    }

    function updateTotals(rows) {
      let totalRtmx = 0;
      let totalLiq = 0;
      for (const r of rows) {
        const rtmxVal = parseFloat(r[2]) || 0;
        const liqVal = parseFloat(r[6]) || 0;
        totalRtmx += rtmxVal;
        totalLiq += liqVal;
      }

      const pctReserved = (totalRtmx / TOTAL_SUPPLY) * 100;
      const pctRemaining = 100 - pctReserved;

      totalRtmxEl.textContent = formatNumber(totalRtmx);
      totalLiquidityEl.textContent = `$${formatNumber(totalLiq)}`;
      pctReservedEl.textContent = pctReserved >= 0.0001 ? pctReserved.toFixed(4) : '<0.0001';
      pctRemainingEl.textContent = pctRemaining >= 0.0001 ? pctRemaining.toFixed(4) : '>99.9999';
    }

    async function fetchSheet(){
      try {
        setStatusLoading(true);
        const res = await fetch(GVIZ_URL, {cache: 'no-store'});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();

        const json = parseGviz(txt);
        const rows = (json.table?.rows || []).map(r => (r.c || []).map(c => {
          if (!c) return '';
          return (typeof c.v === 'object' && c.v !== null && c.v.hasOwnProperty('v')) ? c.v.v : c.v;
        }));

        rawRows = rows;
        lastFetchEl.textContent = 'Terakhir: ' + new Date().toLocaleString();
        setStatusLoading(false);
        applyFilterAndRender();
      } catch (err) {
        console.error('Fetch error:', err);
        lastFetchEl.textContent = 'Error memuat data';
        setStatusLoading(false);
        tbody.innerHTML = `<tr><td colspan="7" class="empty">Gagal ambil data — cek permission sheet & koneksi.</td></tr>`;
      }
    }

    function applyFilterAndRender(){
      const q = (searchInput.value || '').trim().toLowerCase();
      filtered = rawRows.filter(r => {
        const line = (r.join(' ') || '').toLowerCase();
        return !q || line.includes(q);
      });

      const sortMode = sortSelect.value;
      if(sortMode !== 'none') {
        const [field, dir] = sortMode.split('_');
        const idx = field === 'rtmx' ? 2 : (field === 'token' ? 3 : -1);
        if(idx >= 0){
          filtered.sort((a,b) => {
            const va = Number(a[idx]) || 0;
            const vb = Number(b[idx]) || 0;
            return dir === 'desc' ? vb - va : va - vb;
          });
        }
      }

      updateTotals(filtered);
      currentPage = 1;
      renderPage();
    }

    function renderPage(){
      const total = filtered.length;
      if(total === 0){
        tbody.innerHTML = `<tr><td colspan="7" class="empty">Tidak ada data</td></tr>`;
        pagerWrap.style.display = 'none';
        return;
      }

      const pages = Math.ceil(total / PAGE_SIZE);
      if(currentPage > pages) currentPage = pages;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageRows = filtered.slice(start, start + PAGE_SIZE);

      tbody.innerHTML = '';
      for(const r of pageRows){
        const dex = r[0] || '';
        const pair = r[1] || '';
        const rtmx = formatNumber(r[2]);
        const token = formatNumber(r[3]);
        const addr = r[4] || '';
        const updated = formatUpdatedCell(r[5]);
        const liquidity = r[6] || '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="dex-label ${dex.toLowerCase().includes('quick') ? 'quick' : (dex.toLowerCase().includes('uni') ? 'uni' : '')}">${dex || ''}</span></td>
          <td>${pair}</td>
          <td>${rtmx} RTMX</td>
          <td>${token}</td>
          <td>${addr ? `<a class="link" href="${toPolygonscanLink(addr)}" target="_blank" rel="noopener noreferrer">${addr.substring(0,8)}...${addr.slice(-6)}</a>` : '-'}</td>
          <td>${updated}</td>
          <td>$ ${liquidity}</td>
        `;
        tbody.appendChild(tr);
      }

      renderPager(pages);
    }

    function renderPager(totalPages){
      pagerWrap.style.display = totalPages > 1 ? 'flex' : 'none';
      pagerButtons.innerHTML = '';

      const visible = 7;
      let start = Math.max(1, currentPage - Math.floor(visible/2));
      let end = Math.min(totalPages, start + visible - 1);
      if(end - start < visible - 1) start = Math.max(1, end - visible + 1);

      if(start > 1){
        pagerButtons.appendChild(createPageButton(1, '1'));
        if(start > 2) {
          const dots = document.createElement('span'); dots.style.margin='0 6px'; dots.textContent='...'; pagerButtons.appendChild(dots);
        }
      }

      for(let i=start;i<=end;i++){
        pagerButtons.appendChild(createPageButton(i));
      }

      if(end < totalPages){
        if(end < totalPages - 1) {
          const dots2 = document.createElement('span'); dots2.style.margin='0 6px'; dots2.textContent='...'; pagerButtons.appendChild(dots2);
        }
        pagerButtons.appendChild(createPageButton(totalPages, String(totalPages)));
      }
    }

    function createPageButton(page, label){
      const btn = document.createElement('button');
      btn.className = 'page' + (page === currentPage ? ' active' : '');
      btn.textContent = label || page;
      btn.onclick = () => { currentPage = page; renderPage(); };
      return btn;
    }

    // Event listeners
    refreshBtn.addEventListener('click', fetchSheet);
    searchInput.addEventListener('input', debounce(applyFilterAndRender, 250));
    sortSelect.addEventListener('change', applyFilterAndRender);

    downloadCsv.addEventListener('click', () => {
      if(!rawRows.length) return alert('Belum ada data.');
      const csv = [ ['DEX','Pair','RTMX Reserve','Token Reserve','Pair Address','Updated','Total Liquidity'], ...rawRows ]
        .map(r => r.map(cell => `"${String(cell || '').replace(/"/g,'""')}"`).join(','))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `rtmx_liquidity_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });

    openSheet.addEventListener('click', () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`, '_blank');
    });

    function startAutoRefresh(){
      stopAutoRefresh();
      if(autoRefresh.checked){
        const sec = Math.max(10, Number(intervalInput.value) || 60);
        refreshTimer = setInterval(fetchSheet, sec * 1000);
      }
    }

    function stopAutoRefresh(){
      if(refreshTimer) clearInterval(refreshTimer);
      refreshTimer = null;
    }

    autoRefresh.addEventListener('change', () => autoRefresh.checked ? startAutoRefresh() : stopAutoRefresh());
    intervalInput.addEventListener('change', () => autoRefresh.checked && startAutoRefresh());

    function debounce(fn, wait){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

    // Initial load
    (function init(){
      fetchSheet();
      startAutoRefresh();
    })();
  </script>
</body>
</html>
